package com.comcast.homesecurity.domain.dao;

import com.comcast.homesecurity.domain.pojo.Event;
import com.comcast.homesecurity.domain.pojo.Metadata;
import org.apache.log4j.Logger;
import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;

import java.io.IOException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.TimeZone;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertTrue;

@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(locations={"/integrationPersistenceApplicationContext.xml"})
public class CqlEventDaoITest {

    @Autowired
	private EventDao evdao;

    private static final Logger logger = Logger.getLogger(CqlEventDaoITest.class);
    static SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");    
    
	@BeforeClass
	public static void setUpBeforeClass() throws Exception {
		sdf.setTimeZone(TimeZone.getTimeZone("GMT"));
	}

	@AfterClass
	public static void tearDownAfterClass() throws Exception {
	}

	@Test
    public void getKeyspace_ReturnsTestingKeyspace() throws Exception {
        assertEquals("homesecurity", evdao.cqlSession.getLoggedKeyspace());
    }
    
    @Test public void testGetAllEvents() {
	 	Date start = null;
	 	Date end = null;
		String siteId = "100";
		int count = 100;
		try {
			 start = sdf.parse("20130601");
			 end = sdf.parse("20130630");
		} catch (ParseException e) {
			logger.error(e);
		}
		ArrayList <Event> events = (ArrayList<Event>) evdao.getEvents(siteId, start, end, count);
		for (Event ev: (ArrayList<Event>) events){
			logger.debug("event:" +  ev);
		}
		
		assertEquals(6, events.size());
		assertTrue(Integer.parseInt(events.get(0).getEventId()) == 6);
		assertTrue(Integer.parseInt(events.get(5).getEventId()) == 1);
	}
    
    @Test public void testGetSlicedEvents() {
	 	Date start = null;
	 	Date end = null;
		String siteId = "100";
		
		try {
			 start = sdf.parse("20130610");
			 end = sdf.parse("20130611");
		} catch (ParseException e) {
			logger.error(e);
		}
		
		ArrayList <Event> events = (ArrayList<Event>) evdao.getEvents(siteId, start, end);
		assertTrue(events.size() == 4);
		assertTrue(Integer.parseInt(events.get(0).getEventId()) == 4);
		assertTrue(Integer.parseInt(events.get(3).getEventId()) == 1);
	}
    
    @Test public void testGetLimitCountEvents() {
	 	Date start = null;
	 	Date end = null;
		String siteId = "100";
		int count = 3;
		
		try {
			 start = sdf.parse("20130610");
			 end = sdf.parse("20130611");
		} catch (ParseException e) {
			logger.error(e);
		}
		
		ArrayList <Event> events = (ArrayList<Event>) evdao.getEvents(siteId, start, end, count);
		assertTrue(events.size() == 3);
		assertTrue(Integer.parseInt(events.get(0).getEventId()) == 4);
		assertTrue(Integer.parseInt(events.get(2).getEventId()) == 2);
	}
    
    @Test public void testGetNoEvents() {
	 	Date start = null;
	 	Date end = null;
		String siteId = "300";
		
		try {
			 start = sdf.parse("20130610");
			 end = sdf.parse("20130611");
		} catch (ParseException e) {
			logger.error(e);
		}
		
		ArrayList <Event> events = (ArrayList<Event>) evdao.getEvents(siteId, start, end);
		logger.info(events);
		assertEquals(0, events.size());
	}
    
    @Test (expected=Exception.class)
    public void testGetErrorEvents() {
	 	Date start = null;
	 	Date end = null;
		
		try {
			 start = sdf.parse("20130610");
			 end = sdf.parse("20130611");
		} catch (ParseException e) {
			logger.error(e);
		}
		
		evdao.getEvents(null, start, end);
	}

    @Test
    public void testGetEvents () throws IOException {
        List<Event> events = evdao.getBulkEvents(1370844123, 1370845000, 3, 0);
        for (Event event : events) {
           logger.info(event.toString());
        }
    }
    @Test
    public void testSaveEvent1() throws IOException {
       String siteId = "100";

       Event  evt = new Event();
       evt.setChannel("channel");
       evt.setEventId("1");
       evt.setEventName("eventName1");
       evt.setInstance("instance1");
       evt.setMediaType("mediatype1");
       evt.setTimestamp(1370841071000L); // Mon, 10 Jun 2013 01:11:11

       evdao.saveBulkEvents(evt);

       evt = new Event();
       evt.setChannel("channel2");
       evt.setEventId("2");
       evt.setEventName("eventName2");
       evt.setInstance("instance2");
       evt.setMediaType("mediatype2");
       evt.setTimestamp(1370845342000L); // Mon, 10 Jun 2013 02:22:22
       evdao.saveBulkEvents(evt);
       evt = new Event();

       evt.setChannel("channel2");
       evt.setEventId("112");
       evt.setEventName("eventName2");
       evt.setInstance("instance2");
       evt.setMediaType("mediatype2");
       evt.setTimestamp(1370845342000L); // Mon, 10 Jun 2013 02:22:22
       evdao.saveBulkEvents(evt);


       evt = new Event();
       evt .setChannel("channel3");
       evt.setEventId("3");
       evt.setEventName("eventName3");
       evt.setInstance("instance3");
       evt.setMediaType("mediatype3");
       evt.setTimestamp(1370927471000L); // Tue, 11 Jun 2013 01:11:11
       Metadata metadata = new Metadata();
       metadata.setMetadataName("metadataName");
       metadata.setMetadataValue("metadataValue");
       metadata.setWithaction("true");
       evt.addMetadata(metadata);

       evdao.saveBulkEvents(evt);

       evt = new Event();
       evt .setChannel("channel4");
       evt.setEventId("4");
       evt.setEventName("eventName4");
       evt.setInstance("instance4");
       evt.setMediaType("mediatype4");
       evt.setTimestamp( 1370931742000L); // Tue, 11 Jun 2013 02:22:22

       evdao.saveBulkEvents(evt);

       evt = new Event();
       evt .setChannel("channel5");
       evt.setEventId("5");
       evt.setEventName("eventName5");
       evt.setInstance("instance5");
       evt.setMediaType("mediatype5");
       evt.setTimestamp(1371013871000L); // Wed, 12 Jun 2013 01:11:11

       evdao.saveBulkEvents(evt);

       evt = new Event();
       evt .setChannel("channel6");
       evt.setEventId("6");
       evt.setEventName("eventName6");
       evt.setInstance("instance6");
       evt.setMediaType("mediatype6");
       evt.setTimestamp(1371018142000L); // Wed, 12 Jun 2013 02:22:22

       evdao.saveBulkEvents(evt);
    }

    @Test
	public void testSaveEvent() {
	   String siteId = "100"; 
		
       Event  evt = new Event();
       evt.setChannel("channel");
       evt.setEventId("1");
       evt.setEventName("eventName1");
       evt.setInstance("instance1");
       evt.setMediaType("mediatype1");
       evt.setTimestamp(1370841071000L); // Mon, 10 Jun 2013 01:11:11 
 
       evdao.saveEvent(siteId, evt);    
             
       evt = new Event();
       evt.setChannel("channel2");
       evt.setEventId("2");
       evt.setEventName("eventName2");
       evt.setInstance("instance2");
       evt.setMediaType("mediatype2");
       evt.setTimestamp(1370845342000L); // Mon, 10 Jun 2013 02:22:22    
       evdao.saveEvent(siteId, evt);    
       	
       evt = new Event();
       evt .setChannel("channel3");
       evt.setEventId("3");
       evt.setEventName("eventName3");
       evt.setInstance("instance3");
       evt.setMediaType("mediatype3");
       evt.setTimestamp(1370927471000L); // Tue, 11 Jun 2013 01:11:11 
       Metadata metadata = new Metadata();
       metadata.setMetadataName("metadataName");
       metadata.setMetadataValue("metadataValue");
       metadata.setWithaction("true");
       evt.addMetadata(metadata);
 
       evdao.saveEvent(siteId, evt);		
           
       evt = new Event();
       evt .setChannel("channel4");
       evt.setEventId("4");
       evt.setEventName("eventName4");
       evt.setInstance("instance4");
       evt.setMediaType("mediatype4");
       evt.setTimestamp( 1370931742000L); // Tue, 11 Jun 2013 02:22:22 

       evdao.saveEvent(siteId, evt);		

       evt = new Event();
       evt .setChannel("channel5");
       evt.setEventId("5");
       evt.setEventName("eventName5");
       evt.setInstance("instance5");
       evt.setMediaType("mediatype5");
       evt.setTimestamp(1371013871000L); // Wed, 12 Jun 2013 01:11:11 

       evdao.saveEvent(siteId, evt);	
       
       evt = new Event();
       evt .setChannel("channel6");
       evt.setEventId("6");
       evt.setEventName("eventName6");
       evt.setInstance("instance6");
       evt.setMediaType("mediatype6");
       evt.setTimestamp(1371018142000L); // Wed, 12 Jun 2013 02:22:22 
             
       evdao.saveEvent(siteId, evt);
	}
    
    @Test
	public void testSaveEventWarning() {		
    	Event  evt = new Event();
       	evt.setChannel("channel");
       	evt.setEventId("7");
       	evt.setEventName("eventName7");
       	evt.setInstance("instance7");
       	evt.setMediaType("mediatype7");
       	evt.setTimestamp(1370841071000L); // Mon, 10 Jun 2013 01:11:11 
 
       	evdao.saveEvent(null, evt);
    }

    @Test (expected=Exception.class)
	public void testSaveEventError() {
       	String siteId = "100";
       	evdao.saveEvent(siteId, null);
    }
}