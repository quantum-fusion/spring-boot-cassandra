package com.comcast.homesecurity.domain.dao;

import com.datastax.driver.core.*;
import com.datastax.driver.core.querybuilder.Insert;
import com.datastax.driver.core.querybuilder.QueryBuilder;

import org.apache.log4j.Logger;
import org.junit.Before;
import org.junit.Test;

import java.sql.SQLException;

/**
 * Created with IntelliJ IDEA.
 * User: comcast
 * Date: 11/12/13
 * Time: 11:07 AM
 */
public class CQLDriverITest {

    private static final Logger logger = Logger.getLogger(CQLDriverITest.class);

    Cluster cluster;


    //cassandra.read.consistency.level=ONE
    //cassandra.write.consistency.level=ONE
    //cassandra.retryDownedHostsDelayInSeconds=10
    //cassandra.retryDownedHosts=true
    //cassandra.autoDiscoverHosts=true

    @Before
    public void setup () throws Exception {

        PoolingOptions pools = new PoolingOptions();
        pools.setCoreConnectionsPerHost(HostDistance.LOCAL, 10);
        pools.setMaxConnectionsPerHost(HostDistance.LOCAL, 10);
        
        pools.setCoreConnectionsPerHost(HostDistance.REMOTE, 10);
        pools.setMaxConnectionsPerHost(HostDistance.REMOTE, 10);

        String cassandraNodes [] = new String[] {
                "162.150.2.207"
        };

        final Cluster.Builder builder = new Cluster.Builder().addContactPoints(cassandraNodes).withPoolingOptions(pools);

        cluster = builder.build();
        Metadata metadata = cluster.getMetadata();
        logger.info("Connected to cluster: %s\n" +
                 metadata.getClusterName());

    }

    @Test
    public void testConnection () throws SQLException {
        Session session = cluster.connect("homesecurity");

        ResultSet resultSet = session.execute("select * from event");
        logger.info ("Result Set Size=" + resultSet.all().size());
    }
    
    @Test
	public void testTimeline() throws Exception {
    	Session session = cluster.connect("homesecurity");
    	
    	Insert insert = QueryBuilder
    			  .insertInto("homesecurity", "eventtimeline3")
    			  .value("siteId", "12345")
    			  .value("time_taken", System.currentTimeMillis()/1000 + "e-id-1234")
    			  .value("event", "{'email':'James_Miller@comcast.com'}");
    	logger.info(insert.getQueryString());		  
		ResultSet results = session.execute(insert);
		
	}
}
